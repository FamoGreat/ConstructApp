@model ExpenseVM

<partial name="_Notification" />

<div class="container mt-4">
    <div class="row">
        <!-- Column One - Add Project Button -->
        <div class="col-sm-12 col-md-6 mb-2 mb-md-0">
            <p>
                <a class="btn btn-primary" asp-action="Create" asp-controller="Expense"><i class="ti-plus"></i> Add Expense</a>
            </p>
        </div>
    </div>
</div>

<!-- Form for selecting project -->
<div class="form-group">
    <label asp-for="Expense.ProjectId" class="form-label"></label>
    <select id="projectSelect" asp-for="Expense.ProjectId" asp-items="@Model.ProjectList" class="form-control">
        <option disabled selected>-- Select Project --</option>
    </select>
    <span asp-validation-for="Expense.ProjectId" class="text-danger"></span>
</div>

<!-- Table to display expenses -->
<div id="expenseTableContainer" class="container mt-4" style="display:none;">
    <div class="row">
        <div class="col-sm-12">
            <table id="expenseTable" class="table">
                <thead>
                    <tr>
                        <th>Expense Type</th>
                        <th>Amount</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Expenses will be dynamically added here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $(document).on('change', '#projectSelect', function () {
                var projectId = $(this).val();
                if (projectId) {
                    $.ajax({
                        url: '/Expense/GetExpenses',
                        type: 'GET',
                        data: { projectId: projectId },
                        success: function (data) {
                            $('#expenseTableContainer').show();
                            var tbody = $('#expenseTable tbody');
                            tbody.empty();
                            $.each(data, function (index, item) {
                                var row = $('<tr></tr>');
                                row.append($('<td></td>').text(item.expenseType));
                                row.append($('<td></td>').text(item.amount));
                                row.append($('<td></td>').text(item.date));
                                row.append($('<td></td>').html('<a href="/Expense/Edit/' + item.id + '">Edit</a> | <a href="#" onclick="confirmDelete(\'/Expense/Delete/' + item.id + '\', \'Are you sure you want to delete this expense?\')">Delete</a>'));
                                tbody.append(row);
                            });
                        },
                        error: function () {
                            toastr.error('Failed to fetch expenses.');
                        }
                    });
                } else {
                    $('#expenseTableContainer').hide();
                }
            });
        });

        function confirmDelete(url, message) {
            Swal.fire({
                title: "Confirmation",
                text: message,
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, delete it!"
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: url,
                        type: "DELETE",
                        success: function (data) {
                            if (data.success) {
                                toastr.success(data.message);
                                // Reload the respective table
                                var projectId = $('#projectSelect').val();
                                $.ajax({
                                    url: '/Expense/GetExpenses',
                                    type: 'GET',
                                    data: { projectId: projectId },
                                    success: function (data) {
                                        var tbody = $('#expenseTable tbody');
                                        tbody.empty();
                                        $.each(data, function (index, item) {
                                            var row = $('<tr></tr>');
                                            row.append($('<td></td>').text(item.expenseType));
                                            row.append($('<td></td>').text(item.amount));
                                            row.append($('<td></td>').text(item.date));
                                            row.append($('<td></td>').html('<a href="/Expense/Edit/' + item.id + '">Edit</a> | <a href="#" onclick="confirmDelete(\'/Expense/Delete/' + item.id + '\', \'Are you sure you want to delete this expense?\')">Delete</a>'));
                                            tbody.append(row);
                                        });
                                    },
                                    error: function () {
                                        toastr.error('Failed to fetch expenses.');
                                    }
                                });
                            } else {
                                toastr.error(data.message);
                            }
                        },
                        error: function (xhr, status, error) {
                            toastr.error("Error occurred while deleting.");
                        }
                    });
                }
            });
        }
    </script>
}
