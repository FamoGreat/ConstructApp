@model Project

<input asp-for="Id" hidden />
<partial name="_Notification" />

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">@Model.ProjectName</h6>
    </div>
    <div class="card-body">
        <p class="card-text">Location: @Model.Location</p>
        <p class="card-text">Start Date: @Model.StartDate.ToShortDateString()</p>
        <p class="card-text">End Date: @Model.EndDate.ToShortDateString()</p>
        <p class="card-text">Created By: @Model.CreatedBy</p>
        <p class="card-text">Created Date: @Model.CreatedDate.ToShortDateString()</p>
        <p class="card-text">Total Budget: @Model.TotalBudget</p>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">List of Materials</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" id="materialsTable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Material Code</th>
                        <th>Material Name</th>
                        <th>Estimated Quantity</th>
                        <th>Estimated Cost</th>
                        <th>Unit of Measurement</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Project Tools</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" id="toolsTable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Tool Name</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div class="m-4">
    <a href="@Url.Action("Index", "Project")" class="btn btn-secondary">Back to List</a>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            loadMaterialsDataTable();
            loadToolsDataTable();
        });

        function loadMaterialsDataTable() {
            var materialsTable = $('#materialsTable').DataTable({
                "ajax": {
                    "url": `/Project/GetMaterial?id=${@Model.Id}`,
                    "type": "GET",
                    "data": { id: @Model.Id }
                },
                "columns": [
                    {
                        "data": null, "width": "5%", "orderable": false, "searchable": false,
                        "render": function (data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    { "data": 'MaterialCode', "width": "10%" },
                    { "data": 'MaterialName', "width": "20%" },
                    { "data": 'EstimatedQuantity', "width": "10%" },
                    { "data": 'EstimatedCost', "width": "10%" },
                    { "data": 'MaterialUOM', "width": "10%" },
                    {
                        "data": 'Id',
                        "render": function (data) {
                            return `<div class="w-75 btn-group" role="group">
                                        <a href="/ProjectMaterial/Edit?id=${data}" class="m-2 btn btn-sm btn-primary">Edit</a>
                                        <a onClick="deleteMaterial('/ProjectMaterial/Delete/${data}')" class="m-2 btn btn-sm btn-danger">Delete</a>
                                    </div>`;
                        },
                        "width": "20%"
                    }
                ]
            });
        }

        function loadToolsDataTable() {
            var toolsTable = $('#toolsTable').DataTable({
                "ajax": {
                    "url": `/Project/GetTools?id=${@Model.Id}`,
                    "type": "GET",
                    "dataType": "json",
                    "dataSrc": "data"
                },
                "columns": [
                    {
                        "data": null, "width": "5%", "orderable": false, "searchable": false,
                        "render": function (data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    { "data": "ToolName" },
                    {
                        "data": 'Id',
                        "render": function (data) {
                            return `<div class="w-75 btn-group" role="group">
                                        <a href="/ProjectTool/Edit?id=${data}" class="m-2 btn btn-sm btn-primary">Edit</a>
                                        <a onClick="deleteTool('/ProjectTool/Delete/${data}')" class="m-2 btn btn-sm btn-danger">Delete</a>
                                    </div>`;
                        },
                        "width": "20%"
                    }
                ]
            });
        }

        function deleteMaterial(url) {
            confirmDelete(url, "Are you sure you want to delete this material?");
        }

        function deleteTool(url) {
            confirmDelete(url, "Are you sure you want to delete this tool?");
        }

        function confirmDelete(url, message) {
            Swal.fire({
                title: "Confirmation",
                text: message,
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, delete it!"
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: url,
                        type: "DELETE",
                        success: function (data) {
                            if (data.success) {
                                // Reload the respective table
                                $('#materialsTable').DataTable().ajax.reload();
                                $('#toolsTable').DataTable().ajax.reload();
                                toastr.success(data.message);
                            } else {
                                toastr.error(data.message);
                            }
                        },
                        error: function (xhr, status, error) {
                            toastr.error("Error occurred while deleting.");
                        }
                    });
                }
            });
        }
    </script>
}
